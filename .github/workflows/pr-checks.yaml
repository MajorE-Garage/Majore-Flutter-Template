name: PR Analysis and Auto-fix

on:
  pull_request:
    branches: [develop]
    types: [opened, ready_for_review, synchronize]
env:
  flutter_version: "3.32.0"

jobs:
  analyze-and-fix:
    name: Analyze, Fix, and Format Flutter Code
    runs-on: ubuntu-latest
    
    # Skip if PR is draft (unless it was just marked ready for review)
    if: github.event.pull_request.draft == false
    
    permissions:
      contents: write
      pull-requests: write
      checks: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          ref: ${{ github.head_ref }}
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.flutter_version }}
          channel: 'stable'
          cache: true
      
      - name: Get Flutter dependencies
        run: flutter pub get
      
      - name: Run dart fix
        id: dart_fix
        run: |
          echo "Running dart fix..."
          dart fix --apply
          
          # Check if any files were modified
          if [[ -n $(git diff --name-only) ]]; then
            echo "fixes_applied=true" >> $GITHUB_OUTPUT
            echo "Files modified by dart fix:"
            git diff --name-only
          else
            echo "fixes_applied=false" >> $GITHUB_OUTPUT
            echo "No fixes applied by dart fix"
          fi
      
      - name: Run format-project script
        id: format_project
        run: |
          echo "Running format-project script..."
          
          # Check if format-project script exists in root or ./tools
          if [[ -f "format-project" ]]; then
            ./format-project
            echo "Used format-project script from root"
          elif [[ -f "tools/format-project" ]]; then
            ./tools/format-project
            echo "Used format-project script from tools/"
          else
            echo "‚ùå format-project script not found in root or tools/ directory"
            exit 1
          fi
          
          # Check if any files were modified by formatting
          if [[ -n $(git diff --name-only) ]]; then
            echo "formatting_applied=true" >> $GITHUB_OUTPUT
            echo "Files modified by formatting:"
            git diff --name-only
          else
            echo "formatting_applied=false" >> $GITHUB_OUTPUT
            echo "No formatting changes needed"
          fi
      
      - name: Commit fixes and formatting changes
        id: commit_changes
        if: steps.dart_fix.outputs.fixes_applied == 'true' || steps.format_project.outputs.formatting_applied == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add all changed files
          git add .
          
          # Create commit message
          if [[ "${{ steps.dart_fix.outputs.fixes_applied }}" == "true" && "${{ steps.format_project.outputs.formatting_applied }}" == "true" ]]; then
            commit_msg="ü§ñ Auto-fix: Apply dart fixes and code formatting"
          elif [[ "${{ steps.dart_fix.outputs.fixes_applied }}" == "true" ]]; then
            commit_msg="ü§ñ Auto-fix: Apply dart fixes"
          else
            commit_msg="ü§ñ Auto-fix: Apply code formatting"
          fi
          
          git commit -m "$commit_msg"
          git push origin ${{ github.head_ref }}
          echo "changes_committed=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Changes committed and pushed to PR branch"
      
      - name: Run dart analyze
        id: analyze
        run: |
          echo "Running dart analyze..."
          
          # Run analyze and capture output, excluding TODO comments
          if dart analyze --fatal-infos --fatal-warnings | grep -v "TODO" > analyze_output.txt 2>&1; then
            echo "analysis_passed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ No analysis issues found (excluding TODOs)"
          else
            echo "analysis_passed=false" >> $GITHUB_OUTPUT
            echo "‚ùå Analysis issues found:"
            cat analyze_output.txt
          fi
        continue-on-error: true
      
      - name: Create or update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // Find existing bot comment
            const botComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('## üîç Flutter Code Analysis Results')
            );
            
            const analysisPassed = '${{ steps.analyze.outputs.analysis_passed }}' === 'true';
            const fixesApplied = '${{ steps.dart_fix.outputs.fixes_applied }}' === 'true';
            const formattingApplied = '${{ steps.format_project.outputs.formatting_applied }}' === 'true';
            const changesCommitted = '${{ steps.commit_changes.outputs.changes_committed }}' === 'true';
            
            let statusIcon = analysisPassed ? '‚úÖ' : '‚ùå';
            let statusText = analysisPassed ? 'No analysis issues found' : 'Analysis issues detected';
            
            let actionsSection = '';
            if (fixesApplied || formattingApplied) {
              actionsSection = '\n## ü§ñ Auto-fixes Applied\n\n';
              if (fixesApplied) actionsSection += '- ‚úÖ Applied `dart fix` corrections\n';
              if (formattingApplied) actionsSection += '- ‚úÖ Applied code formatting\n';
              if (changesCommitted) {
                actionsSection += '\nüíæ Changes have been automatically committed to this PR branch.\n';
              }
            }
            
            const commentBody = `## üîç Flutter Code Analysis Results
            
            ${statusIcon} **${statusText}**
            ${actionsSection}
            ${!analysisPassed ? '\n‚ùå **This PR introduces analysis issues and cannot be merged until they are resolved.**' : ''}
            
            ---
            *Analysis excludes TODO comments. This comment was automatically generated by the Flutter PR Analysis workflow.*`;
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }
      
      - name: Block PR if analysis fails
        if: steps.analyze.outputs.analysis_passed != 'true'
        run: |
          echo "‚ùå Analysis failed: Issues detected that are not TODO comments"
          echo "This PR cannot be merged until all analysis issues are resolved."
          exit 1